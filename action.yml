name: 'LeftSize Cloud Cost Optimization'
description: 'Scan AWS and Azure infrastructure for cost optimization opportunities using Cloud Custodian'
author: 'LeftSize'
branding:
  icon: 'cloud'
  color: 'blue'

inputs:
  # Mode selection
  mode:
    description: 'Action mode: scan (default) or stats'
    required: false
    default: 'scan'
  
  # Required inputs
  installation-id:
    description: 'GitHub App installation ID (from LeftSize onboarding)'
    required: true
  
  repository-token:
    description: 'Secure repository token (from LeftSize onboarding)'
    required: true
  
  # Backend configuration
  backend-url:
    description: 'LeftSize backend API URL'
    required: false
    default: 'https://api.leftsize.com'
  
  # Stats mode inputs
  period:
    description: 'Stats period: 7d, 30d, 90d, or all (stats mode only)'
    required: false
    default: '30d'
  
  format:
    description: 'Output format: json or markdown (stats mode only)'
    required: false
    default: 'markdown'
  
  report:
    description: 'Report type: summary, detailed, or executive (stats mode only)'
    required: false
    default: 'summary'
  
  # Cloud provider configuration (scan mode)
  cloud-provider:
    description: 'Cloud provider to scan (azure or aws)'
    required: false
    default: 'azure'
  
  # Azure-specific inputs
  azure-subscription-ids:
    description: 'Comma-separated Azure subscription IDs to scan (empty = all accessible)'
    required: false
  
  # AWS-specific inputs
  aws-regions:
    description: 'Comma-separated AWS regions to scan (empty = all accessible)'
    required: false
  
  # Currency configuration
  currency:
    description: 'Currency code for cost display (e.g., EUR, USD, GBP). Auto-detected from Azure if not specified.'
    required: false
  
  # Policy configuration
  include-policies:
    description: 'Comma-separated policy categories to include (e.g., cost-optimization,governance,security)'
    required: false
  
  exclude-policies:
    description: 'Comma-separated specific policy names to exclude (e.g., leftsize-idle-vm)'
    required: false
  
  # Execution options
  verbose:
    description: 'Enable verbose logging'
    required: false
    default: 'false'

outputs:
  # Scan mode outputs
  findings-count:
    description: 'Total number of findings detected (scan mode)'
    value: ${{ steps.run.outputs.findings-count }}
  
  findings-submitted:
    description: 'Whether findings were successfully submitted to backend (scan mode)'
    value: ${{ steps.run.outputs.findings-submitted }}
  
  findings-json:
    description: 'JSON string of all findings (scan mode)'
    value: ${{ steps.run.outputs.findings-json }}
  
  # Stats mode outputs
  report:
    description: 'Generated report content (stats mode, markdown or json)'
    value: ${{ steps.run.outputs.report }}
  
  stats-json:
    description: 'Raw statistics as JSON (stats mode)'
    value: ${{ steps.run.outputs.stats-json }}
  
  fix-ratio:
    description: 'Fix ratio percentage (stats mode)'
    value: ${{ steps.run.outputs.fix-ratio }}
  
  potential-savings:
    description: 'Potential monthly savings (stats mode)'
    value: ${{ steps.run.outputs.potential-savings }}
  
  realized-savings:
    description: 'Realized monthly savings (stats mode)'
    value: ${{ steps.run.outputs.realized-savings }}

runs:
  using: 'composite'
  steps:
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-leftsize-${{ hashFiles(format('{0}/requirements.txt', github.action_path)) }}
        restore-keys: |
          ${{ runner.os }}-pip-leftsize-
    
    - name: Install dependencies
      shell: bash
      run: |
        pip install --quiet -r "${{ github.action_path }}/requirements.txt"
    
    - name: Run LeftSize
      id: run
      shell: bash
      env:
        LEFTSIZE_MODE: ${{ inputs.mode }}
        LEFTSIZE_INSTALLATION_ID: ${{ inputs.installation-id }}
        LEFTSIZE_REPOSITORY_TOKEN: ${{ inputs.repository-token }}
        LEFTSIZE_BACKEND_URL: ${{ inputs.backend-url }}
        LEFTSIZE_PERIOD: ${{ inputs.period }}
        LEFTSIZE_FORMAT: ${{ inputs.format }}
        LEFTSIZE_REPORT: ${{ inputs.report }}
        LEFTSIZE_CLOUD_PROVIDER: ${{ inputs.cloud-provider }}
        LEFTSIZE_AZURE_SUBSCRIPTION_IDS: ${{ inputs.azure-subscription-ids }}
        LEFTSIZE_AWS_REGIONS: ${{ inputs.aws-regions }}
        LEFTSIZE_CURRENCY: ${{ inputs.currency }}
        LEFTSIZE_INCLUDE_POLICIES: ${{ inputs.include-policies }}
        LEFTSIZE_EXCLUDE_POLICIES: ${{ inputs.exclude-policies }}
        LEFTSIZE_VERBOSE: ${{ inputs.verbose }}
      run: |
        MODE="${LEFTSIZE_MODE:-scan}"
        
        if [ "$MODE" = "stats" ]; then
          echo "::group::LeftSize Statistics Report"
          echo "Mode: stats"
          echo "Period: ${LEFTSIZE_PERIOD}"
          echo "Format: ${LEFTSIZE_FORMAT}"
          echo "Report: ${LEFTSIZE_REPORT}"
          echo "::endgroup::"
        else
          echo "::group::LeftSize Cloud Cost Optimization Scanner"
          echo "Mode: scan"
          echo "Cloud Provider: ${LEFTSIZE_CLOUD_PROVIDER}"
          echo "::endgroup::"
        fi
        
        # Run the Python runner
        python3 "${{ github.action_path }}/run.py"
        
        # Capture exit code
        EXIT_CODE=$?
        
        if [ $EXIT_CODE -eq 0 ]; then
          if [ "$MODE" = "stats" ]; then
            echo "✅ LeftSize stats completed successfully"
          else
            echo "✅ LeftSize scan completed successfully"
          fi
        else
          echo "❌ LeftSize failed with exit code $EXIT_CODE"
          exit $EXIT_CODE
        fi
