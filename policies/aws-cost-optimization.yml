policies:
  # ========================================
  # ðŸ“¦ ECS / FARGATE
  # ========================================
  - name: leftsize-idle-ecs-container-instances
    description: "Find ECS clusters with idle container instances due to high ASG minimum capacity"
    resource: aws.asg
    filters:
      # ASG must be associated with an ECS cluster (has specific tag)
      - type: value
        key: 'Tags'
        value: present
      - or:
        - type: value
          key: 'tag:aws:ecs:cluster-name'
          value: present
        # Or tagged as ECS capacity provider
        - type: value
          key: 'tag:AmazonECSManaged'
          value: present
      # ASG has minimum capacity > 1
      - type: value
        key: 'MinSize'
        op: greater-than
        value: 1
      # Check if actual instances exceed what's needed
      # (Custom filter would check ECS container instance utilization)
      # For now, flag ASGs with high minimum for manual review
      - type: value
        key: 'MinSize'
        op: gte
        value: 3
      # ASG has been active for at least 14 days
      - type: value
        key: 'CreatedTime'
        op: less-than
        value_type: age
        value: 14
    actions:
      - type: tag
        key: leftsize-ecs-capacity-review
        value: 'check-for-idle-instances'

  - name: leftsize-fargate-spot-eligible
    description: "Find ECS services using regular Fargate that could use Fargate Spot for 70% savings"
    resource: aws.ecs-service
    filters:
      # Only active services
      - type: value
        key: 'status'
        value: 'ACTIVE'
      # Services using Fargate launch type (not EC2)
      - or:
        - type: value
          key: 'launchType'
          value: 'FARGATE'
        # Or using FARGATE capacity provider (but not SPOT)
        - and:
          - type: value
            key: 'capacityProviderStrategy[].capacityProvider'
            op: contains
            value: 'FARGATE'
          - not:
            - type: value
              key: 'capacityProviderStrategy[].capacityProvider'
              op: contains
              value: 'FARGATE_SPOT'
      # Exclude production services (unless tagged as Spot-eligible)
      - or:
        # Non-production environments
        - type: value
          key: 'tags'
          value: present
        - not:
          - type: value
            key: 'tag:Environment'
            op: in
            value: ['prod', 'production', 'prd']
        # Or explicitly tagged as Spot-eligible
        - type: value
          key: 'tag:SpotEligible'
          value: 'true'
      # Services with multiple tasks (better for handling interruptions)
      - type: value
        key: 'desiredCount'
        op: gte
        value: 2
      # Service has been running for at least 7 days
      - type: value
        key: 'createdAt'
        op: less-than
        value_type: age
        value: 7
    actions:
      - type: tag
        key: leftsize-fargate-spot-eligible
        value: 'review-for-spot-migration'

  # ========================================
  # ðŸ–¥ï¸ EC2 INSTANCES
  # ========================================
  - name: leftsize-inactive-ec2-instance
    description: "Find inactive EC2 instances with low CPU and network utilization"
    resource: aws.ec2
    filters:
      # Only check running instances
      - type: value
        key: 'State.Name'
        value: 'running'
      # Instance must be running for at least 7 days
      - type: instance-age
        op: gte
        days: 7
      # Low CPU utilization (â‰¤5% average over 7 days)
      - type: metrics
        name: CPUUtilization
        namespace: AWS/EC2
        dimensions:
          InstanceId: instance-id
        op: less-than
        value: 5
        percent-attr: Average
        days: 7
      # Low network output (minimal activity)
      - type: metrics
        name: NetworkOut
        namespace: AWS/EC2
        dimensions:
          InstanceId: instance-id
        op: less-than
        value: 1000000  # 1MB total over 7 days
        statistics: Sum
        days: 7
    actions:
      - type: mark-for-op
        op: stop
        days: 3
        tag: leftsize-inactive-ec2-stop

  - name: leftsize-underutilized-ec2-instance
    description: "Find underutilized EC2 instances with low but non-zero CPU usage (right-sizing candidates)"
    resource: aws.ec2
    filters:
      # Only running instances
      - type: value
        key: 'State.Name'
        value: 'running'
      # Instance running for at least 14 days (need longer period for utilization trends)
      - type: instance-age
        op: gte
        days: 14
      # CPU utilization between 10-40% average over 14 days (underutilized but not idle)
      - and:
        - type: metrics
          name: CPUUtilization
          namespace: AWS/EC2
          dimensions:
            InstanceId: instance-id
          op: greater-than
          value: 10
          percent-attr: Average
          days: 14
        - type: metrics
          name: CPUUtilization
          namespace: AWS/EC2
          dimensions:
            InstanceId: instance-id
          op: less-than
          value: 40
          percent-attr: Average
          days: 14
      # Exclude t2/t3/t4g burstable instances (they're designed for variable loads)
      - not:
        - type: value
          key: 'InstanceType'
          op: regex
          value: '^(t2|t3|t4g)\.'
      # Exclude instances already tagged as optimized
      - not:
        - type: value
          key: 'tag:RightSized'
          value: present
    actions:
      - type: mark-for-op
        op: tag
        days: 7
        tag: leftsize-underutilized-ec2-review

  - name: leftsize-multi-az-nonprod-ec2
    description: "Find non-production EC2 instances spread across multiple AZs (unnecessary HA)"
    resource: aws.ec2
    filters:
      # Only running instances
      - type: value
        key: 'State.Name'
        value: 'running'
      # Non-production environments
      - type: value
        key: 'Tags'
        value: present
      - or:
        - type: value
          key: 'tag:Environment'
          op: in
          value: ['dev', 'development', 'test', 'testing', 'staging', 'qa', 'sandbox']
        - type: value
          key: 'tag:Env'
          op: in
          value: ['dev', 'development', 'test', 'testing', 'staging', 'qa', 'sandbox']
      # Instance has been running for at least 7 days (avoid catching new deployments)
      - type: instance-age
        op: gte
        days: 7
    # Note: The policy will flag instances. Manual review needed to identify which AZs to consolidate.
    actions:
      - type: mark-for-op
        op: tag
        days: 14
        tag: leftsize-multi-az-review

  # ========================================
  # ðŸ’¾ EBS VOLUMES
  # ========================================
  - name: leftsize-unattached-ebs-volume
    description: "Find unattached EBS volumes that can be deleted"
    resource: aws.ebs
    filters:
      # Volume is not attached to any instance
      - type: value
        key: 'State'
        value: 'available'
      # Volume is older than 7 days (avoid temporary detachments)
      - type: value
        key: 'CreateTime'
        op: less-than
        value_type: age
        value: 7
      # Not a snapshot (those are handled separately)
      - not:
        - type: value
          key: 'SnapshotId'
          value: present
    actions:
      - type: mark-for-op
        op: delete
        days: 30
        tag: leftsize-unattached-ebs-delete

  # ========================================
  # ðŸŒ ELASTIC IPs
  # ========================================
  - name: leftsize-unused-elastic-ip
    description: "Find unused Elastic IP addresses that can be released"
    resource: aws.network-addr
    filters:
      # Not associated with any instance or network interface
      - type: value
        key: 'AssociationId'
        value: absent
    actions:
      - type: mark-for-op
        op: release
        days: 7
        tag: leftsize-unused-eip-release

  # ========================================
  # ðŸ—„ï¸ RDS INSTANCES
  # ========================================
  - name: leftsize-idle-rds-instance
    description: "Find RDS instances with low connection and CPU utilization"
    resource: aws.rds
    filters:
      # Only check available (running) instances
      - type: value
        key: 'DBInstanceStatus'
        value: 'available'
      # Low CPU utilization (â‰¤10% average over 7 days)
      - type: metrics
        name: CPUUtilization
        namespace: AWS/RDS
        op: less-than
        value: 10
        percent-attr: Average
        days: 7
      # Low database connections (â‰¤2 average over 7 days)
      - type: metrics
        name: DatabaseConnections
        namespace: AWS/RDS
        op: less-than
        value: 2
        statistics: Average
        days: 7
    actions:
      - type: mark-for-op
        op: stop
        days: 7
        tag: leftsize-idle-rds-stop

  # ========================================
  # ðŸ”„ LOAD BALANCERS
  # ========================================
  - name: leftsize-unused-load-balancer
    description: "Find load balancers with no active targets"
    resource: aws.elb
    filters:
      # No healthy targets
      - type: value
        key: 'Instances'
        value: []
      # Load balancer is older than 3 days
      - type: value
        key: 'CreatedTime'
        op: less-than
        value_type: age
        value: 3
    actions:
      - type: mark-for-op
        op: delete
        days: 14
        tag: leftsize-unused-elb-delete

  - name: leftsize-unused-alb
    description: "Find Application Load Balancers with no active target groups"
    resource: aws.app-elb
    filters:
      # Load balancer is older than 3 days
      - type: value
        key: 'CreatedTime'
        op: less-than
        value_type: age
        value: 3
      # Very low request count (effectively unused)
      - type: metrics
        name: RequestCount
        namespace: AWS/ApplicationELB
        op: less-than
        value: 10
        statistics: Sum
        days: 7
    actions:
      - type: mark-for-op
        op: delete
        days: 14
        tag: leftsize-unused-alb-delete

  # ========================================
  # ðŸ’° COST OPTIMIZATION - Advanced Rules
  # ========================================

  - name: leftsize-orphaned-ebs-snapshots
    description: "Find old EBS snapshots (>30 days) where source volume no longer exists"
    resource: aws.ebs-snapshot
    filters:
      # Snapshot is older than 30 days
      - type: age
        days: 30
        op: gte
      # Owned by current account (not shared/public AMI snapshots)
      - type: value
        key: 'OwnerId'
        value: present
      # Source volume no longer exists (orphaned)
      - or:
        - type: value
          key: 'VolumeId'
          value: absent
        - type: value
          key: 'VolumeId'
          value: ''
    actions:
      - type: mark-for-op
        op: delete
        days: 14
        tag: leftsize-orphaned-snapshot-delete

  - name: leftsize-ec2-outdated-generation
    description: "Find EC2 instances on older generations (4th gen or earlier) - 10-40% savings available"
    resource: aws.ec2
    filters:
      # Only running instances
      - type: value
        key: 'State.Name'
        value: 'running'
      # Older instance generations (m4, c4, r4, i2, d2, h1, etc.)
      - type: value
        key: 'InstanceType'
        op: regex
        value: '^(m[1-4]|c[1-4]|r[1-4]|i[1-2]|d2|h1|g3|p2|x1)\.'
      # Instance has been running for at least 7 days
      - type: instance-age
        op: gte
        days: 7
    actions:
      - type: mark-for-op
        op: tag
        days: 7
        tag: leftsize-outdated-generation-review

  - name: leftsize-ec2-scheduled-shutdown-missing
    description: "Find non-production EC2 instances running 24/7 without scheduled shutdown (30-70% savings)"
    resource: aws.ec2
    filters:
      # Only running instances
      - type: value
        key: 'State.Name'
        value: 'running'
      # Non-production environments based on tags
      - or:
        - type: value
          key: 'tag:Environment'
          op: in
          value: ['dev', 'development', 'test', 'testing', 'staging', 'qa', 'sandbox']
        - type: value
          key: 'tag:Env'
          op: in
          value: ['dev', 'development', 'test', 'testing', 'staging', 'qa', 'sandbox']
        - type: value
          key: 'tag:environment'
          op: in
          value: ['dev', 'development', 'test', 'testing', 'staging', 'qa', 'sandbox']
      # Not already tagged for scheduling
      - not:
        - or:
          - type: value
            key: 'tag:Schedule'
            value: present
          - type: value
            key: 'tag:AutoStop'
            value: present
          - type: value
            key: 'tag:StopSchedule'
            value: present
      # Instance has been running for at least 7 days
      - type: instance-age
        op: gte
        days: 7
    actions:
      - type: mark-for-op
        op: tag
        days: 7
        tag: leftsize-schedule-review

  - name: leftsize-s3-intelligent-tiering-missing
    description: "Find S3 buckets not using Intelligent-Tiering (40-70% savings on infrequent data)"
    resource: aws.s3
    filters:
      # Bucket exists
      - type: value
        key: 'Name'
        value: present
      # No intelligent-tiering configuration on this bucket
      - type: intelligent-tiering
        count: 0
        count_op: eq
    actions:
      - type: mark-for-op
        op: tag
        days: 7
        tag: leftsize-intelligent-tiering-review

  - name: leftsize-gp2-to-gp3-migration
    description: "Find EBS volumes still using gp2 - migrate to gp3 for 20% savings and better performance"
    resource: aws.ebs
    filters:
      # Volume is gp2 type
      - type: value
        key: 'VolumeType'
        value: 'gp2'
      # Volume is in-use (attached to an instance)
      - type: value
        key: 'State'
        value: 'in-use'
      # Volume is older than 7 days
      - type: value
        key: 'CreateTime'
        op: less-than
        value_type: age
        value: 7
    actions:
      - type: mark-for-op
        op: tag
        days: 7
        tag: leftsize-gp3-migration-review

  # ========================================
  # ðŸ’° COST OPTIMIZATION - Batch 2
  # ========================================

  - name: leftsize-rds-outdated-version
    description: "Find RDS instances on MySQL 5.7/PostgreSQL 11 triggering Extended Support charges"
    resource: aws.rds
    filters:
      # Only available (running) instances
      - type: value
        key: 'DBInstanceStatus'
        value: 'available'
      # MySQL 5.7 or PostgreSQL 11 (Extended Support versions)
      - or:
        - and:
          - type: value
            key: 'Engine'
            value: 'mysql'
          - type: value
            key: 'EngineVersion'
            op: regex
            value: '^5\.7\.'
        - and:
          - type: value
            key: 'Engine'
            value: 'postgres'
          - type: value
            key: 'EngineVersion'
            op: regex
            value: '^11\.'
    actions:
      - type: mark-for-op
        op: tag
        days: 14
        tag: leftsize-rds-version-upgrade

  - name: leftsize-rds-multiaz-nonprod
    description: "Find non-production RDS instances with unnecessary Multi-AZ (2x cost)"
    resource: aws.rds
    filters:
      # Only available (running) instances
      - type: value
        key: 'DBInstanceStatus'
        value: 'available'
      # Multi-AZ enabled
      - type: value
        key: 'MultiAZ'
        value: true
      # Non-production environments based on tags
      - or:
        - type: value
          key: 'tag:Environment'
          op: in
          value: ['dev', 'development', 'test', 'testing', 'staging', 'qa', 'sandbox']
        - type: value
          key: 'tag:Env'
          op: in
          value: ['dev', 'development', 'test', 'testing', 'staging', 'qa', 'sandbox']
        - type: value
          key: 'tag:environment'
          op: in
          value: ['dev', 'development', 'test', 'testing', 'staging', 'qa', 'sandbox']
        # Or DB instance identifier contains non-prod keywords
        - type: value
          key: 'DBInstanceIdentifier'
          op: regex
          value: '(dev|test|staging|qa|sandbox)'
    actions:
      - type: mark-for-op
        op: tag
        days: 7
        tag: leftsize-multiaz-review

  - name: leftsize-rds-non-graviton
    description: "Find RDS instances using x86 instead of Graviton (20-40% savings)"
    resource: aws.rds
    filters:
      # Only available (running) instances
      - type: value
        key: 'DBInstanceStatus'
        value: 'available'
      # Graviton-compatible engines (MySQL, PostgreSQL, MariaDB)
      - type: value
        key: 'Engine'
        op: in
        value: ['mysql', 'postgres', 'mariadb']
      # x86 instance classes (not Graviton - db.*.g)
      - not:
        - type: value
          key: 'DBInstanceClass'
          op: regex
          value: 'db\.[a-z]+[0-9]+g\.'
      # Current generation instances only (m5, m6i, r5, r6i, t3)
      - type: value
        key: 'DBInstanceClass'
        op: regex
        value: 'db\.(m[56]i?|r[56]i?|t3)\.'
    actions:
      - type: mark-for-op
        op: tag
        days: 14
        tag: leftsize-graviton-review

  - name: leftsize-lambda-x86-architecture
    description: "Find Lambda functions using x86 instead of ARM (20% savings)"
    resource: aws.lambda
    filters:
      # Default architecture is x86_64 (ARM is arm64)
      - or:
        - type: value
          key: 'Architectures'
          value: absent
        - type: value
          key: 'Architectures[0]'
          value: 'x86_64'
      # Exclude functions with custom runtimes (may need x86)
      - not:
        - type: value
          key: 'Runtime'
          op: in
          value: ['provided', 'provided.al2', 'provided.al2023']
      # Function has been invoked recently (active)
      - type: metrics
        name: Invocations
        namespace: AWS/Lambda
        dimensions:
          FunctionName: Name
        op: greater-than
        value: 0
        statistics: Sum
        days: 7
    actions:
      - type: mark-for-op
        op: tag
        days: 7
        tag: leftsize-lambda-arm-review

  - name: leftsize-inactive-nat-gateway
    description: "Find NAT Gateways with no traffic (pure waste)"
    resource: aws.nat-gateway
    filters:
      # Only active gateways
      - type: value
        key: 'State'
        value: 'available'
      # No outbound traffic in 7 days
      - type: metrics
        name: BytesOutToDestination
        namespace: AWS/NATGateway
        dimensions:
          NatGatewayId: NatGatewayId
        op: equal
        value: 0
        statistics: Sum
        days: 7
      # Gateway is older than 7 days
      - type: value
        key: 'CreateTime'
        op: less-than
        value_type: age
        value: 7
    actions:
      - type: mark-for-op
        op: delete
        days: 14
        tag: leftsize-inactive-nat-delete

  - name: leftsize-ebs-delete-on-termination-disabled
    description: "Find EBS volumes with DeleteOnTermination disabled that will orphan"
    resource: aws.ec2
    filters:
      # Only running instances
      - type: value
        key: 'State.Name'
        value: 'running'
      # Has EBS volumes with DeleteOnTermination=false
      - type: value
        key: 'BlockDeviceMappings[].Ebs.DeleteOnTermination'
        op: contains
        value: false
      # Instance has been running for at least 7 days
      - type: instance-age
        op: gte
        days: 7
    actions:
      - type: mark-for-op
        op: tag
        days: 7
        tag: leftsize-delete-on-termination-review
