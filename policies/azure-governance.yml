# ========================================
# Azure Governance & Security Policies
# ========================================
#
# This policy file contains rules for detecting security misconfigurations,
# compliance violations, and governance issues in Azure.
#
# These are NOT cost optimization rules - they are security and governance
# best practices that apply to any organization.
#
# Category: governance, security, compliance
# ========================================

policies:
  # ========================================
  # üíæ STORAGE SECURITY
  # ========================================
  
  # CRITICAL: Anonymous blob access allows anyone to read data without authentication
  - name: leftsize-anonymous-blob-access
    description: |
      CRITICAL: Detect Azure Storage Accounts that allow anonymous blob access.
      
      When allowBlobPublicAccess is enabled, containers can be configured for anonymous
      read access, allowing anyone on the internet to read data without authentication.
      This is the #1 cause of cloud data breaches.
      
      Detection criteria:
      - allowBlobPublicAccess property is set to true
      - Containers can be configured for anonymous access
      
      Security impact: CRITICAL - Direct data breach risk, no authentication required
      Compliance: CIS Azure Foundations 3.7, ISO 27001, SOC2, GDPR Article 32
    
    resource: azure.storage
    metadata:
      tier: pro
    
    filters:
      # Allow blob public access is enabled
      - type: value
        key: properties.allowBlobPublicAccess
        value: true
    
    actions:
      - type: tag
        tag: 'leftsize-security-issue'
        value: 'anonymous-blob-access'
      
      - type: tag
        tag: 'leftsize-severity'
        value: 'critical'
      
      - type: tag
        tag: 'leftsize-compliance'
        value: 'CIS-Azure-Foundations-3.7'
      
      - type: tag
        tag: 'leftsize-detected-date'
        value: '{now:%Y-%m-%d}'
      
      - type: mark-for-op
        op: notify
        days: 1
        tag: leftsize-anonymous-blob-access-notify

  # HIGH: HTTP traffic allowed creates man-in-the-middle attack risk
  - name: leftsize-storage-http-allowed
    description: |
      Detect Azure Storage Accounts that allow unencrypted HTTP traffic.
      
      When supportsHttpsTrafficOnly is false, the storage account accepts HTTP
      connections without encryption, exposing data to interception and tampering.
      
      Detection criteria:
      - supportsHttpsTrafficOnly property is false
      - HTTP (unencrypted) connections are allowed
      
      Security impact: HIGH - Man-in-the-middle attacks, data interception
      Compliance: CIS Azure Foundations 3.1, PCI-DSS 4.1, SOC2, ISO 27001
    
    resource: azure.storage
    metadata:
      tier: pro
    
    filters:
      # HTTPS only is NOT enforced
      - type: value
        key: properties.supportsHttpsTrafficOnly
        value: false
    
    actions:
      - type: tag
        tag: 'leftsize-security-issue'
        value: 'http-allowed'
      
      - type: tag
        tag: 'leftsize-severity'
        value: 'high'
      
      - type: tag
        tag: 'leftsize-compliance'
        value: 'CIS-Azure-Foundations-3.1'
      
      - type: tag
        tag: 'leftsize-detected-date'
        value: '{now:%Y-%m-%d}'
      
      - type: mark-for-op
        op: notify
        days: 1
        tag: leftsize-storage-http-allowed-notify

  # MEDIUM: Public network access without restrictions (defense-in-depth recommendation)
  - name: leftsize-storage-public-network-access
    description: |
      Detect Azure Storage Accounts accessible from public internet without network restrictions.
      
      When publicNetworkAccess is enabled without firewall rules or private endpoints,
      the storage account is reachable from any IP address on the internet. While
      authentication is still required, this increases attack surface.
      
      Detection criteria:
      - publicNetworkAccess is 'Enabled'
      - Network ACL default action is 'Allow' (no IP restrictions)
      
      Security impact: MEDIUM - Increased attack surface, authentication still required
      Compliance: CIS Azure Foundations 3.7 (defense-in-depth), ISO 27001
      
      Note: This is a defense-in-depth recommendation. Consider using private endpoints
      or firewall rules for production storage accounts containing sensitive data.
    
    resource: azure.storage
    metadata:
      tier: pro
    
    filters:
      # Public network access is enabled
      - type: value
        key: properties.publicNetworkAccess
        value: 'Enabled'
      
      # No firewall restrictions (default action is Allow)
      - type: value
        key: properties.networkAcls.defaultAction
        value: 'Allow'
    
    actions:
      - type: tag
        tag: 'leftsize-security-issue'
        value: 'public-network-access'
      
      - type: tag
        tag: 'leftsize-severity'
        value: 'medium'
      
      - type: tag
        tag: 'leftsize-compliance'
        value: 'CIS-Azure-Foundations-3.7'
      
      - type: tag
        tag: 'leftsize-detected-date'
        value: '{now:%Y-%m-%d}'
      
      - type: mark-for-op
        op: notify
        days: 1
        tag: leftsize-storage-public-network-notify

  - name: leftsize-unencrypted-storage
    description: |
      Ensure all Azure Storage Accounts have encryption enabled at rest.
      
      Unencrypted storage violates security best practices and regulatory standards.
      Encryption is a simple, low-cost safeguard against data theft.
      
      Detection criteria:
      - Storage account without encryption for services (blob, file, table, queue)
      - Customer-managed keys not configured where required
      
      Security impact: HIGH - Data exposure risk
      Compliance: CIS Azure Foundations, ISO 27001, SOC2, PCI-DSS
    
    resource: azure.storage
    metadata:
      tier: pro
    
    filters:
      # Check if encryption is disabled for any service
      - or:
        # Blob encryption disabled
        - type: value
          key: properties.encryption.services.blob.enabled
          value: false
        
        # File encryption disabled
        - type: value
          key: properties.encryption.services.file.enabled
          value: false
    
    actions:
      - type: tag
        tag: 'leftsize-security-issue'
        value: 'unencrypted-storage'
      
      - type: tag
        tag: 'leftsize-severity'
        value: 'high'
      
      - type: tag
        tag: 'leftsize-compliance'
        value: 'CIS-Azure-Foundations'
      
      - type: tag
        tag: 'leftsize-detected-date'
        value: '{now:%Y-%m-%d}'
      
      - type: mark-for-op
        op: notify
        days: 1
        tag: leftsize-unencrypted-storage-notify

  # ========================================
  # üîí NETWORK SECURITY
  # ========================================
  
  - name: leftsize-open-network-ports
    description: |
      Identify Network Security Groups with inbound rules exposing sensitive ports to the internet.
      
      Inbound rules allowing 0.0.0.0/0 or * on admin/database ports are a major attack surface.
      These misconfigurations are often unnecessary and lead to intrusion or data loss.
      
      Detection criteria:
      - Inbound rules from 0.0.0.0/0 or Internet tag
      - Sensitive ports: SSH (22), RDP (3389), SQL (1433, 3306, 5432), Elasticsearch (9200)
      - Rule priority allows access
      
      Security impact: CRITICAL - Direct intrusion risk
      Compliance: CIS Azure Foundations, PCI-DSS, NIST
    
    resource: azure.networksecuritygroup
    metadata:
      tier: pro
    
    filters:
      # Has at least one security rule
      - type: value
        key: properties.securityRules
        value: not-null
      
      # Check for dangerous inbound rules
      - type: value
        key: properties.securityRules[?direction=='Inbound' && access=='Allow'].sourceAddressPrefix
        op: in
        value_type: swap
        value:
          - '*'
          - '0.0.0.0/0'
          - 'Internet'
      
      # Check for sensitive ports in destination
      - type: value
        key: properties.securityRules[?direction=='Inbound' && access=='Allow'].destinationPortRange
        op: in
        value_type: swap
        value:
          - '22'      # SSH
          - '3389'    # RDP
          - '1433'    # SQL Server
          - '3306'    # MySQL
          - '5432'    # PostgreSQL
          - '9200'    # Elasticsearch
          - '27017'   # MongoDB
          - '*'       # All ports
    
    actions:
      - type: tag
        tag: 'leftsize-security-issue'
        value: 'open-network-ports'
      
      - type: tag
        tag: 'leftsize-severity'
        value: 'critical'
      
      - type: tag
        tag: 'leftsize-compliance'
        value: 'CIS-Azure-Foundations'
      
      - type: tag
        tag: 'leftsize-detected-date'
        value: '{now:%Y-%m-%d}'
      
      - type: mark-for-op
        op: notify
        days: 1
        tag: leftsize-open-ports-notify

  # ========================================
  # üíø DISK ENCRYPTION
  # ========================================
  
  - name: leftsize-unencrypted-disks
    description: |
      Ensure all Azure Managed Disks have encryption enabled.
      
      Unencrypted disks violate security best practices and can breach regulatory standards.
      Encryption at rest protects against unauthorized data access.
      
      Detection criteria:
      - Managed disks without encryption enabled
      - OS and data disks checked
      
      Security impact: HIGH - Data exposure risk
      Compliance: CIS Azure Foundations, ISO 27001, PCI-DSS
    
    resource: azure.disk
    metadata:
      tier: pro
    
    filters:
      # Encryption is not enabled
      - type: value
        key: properties.encryption.type
        op: ne
        value: 'EncryptionAtRestWithPlatformKey'
      
      # Also catch disks with no encryption property set
      - or:
        - type: value
          key: properties.encryption
          value: null
        
        - type: value
          key: properties.encryption.type
          value: null
    
    actions:
      - type: tag
        tag: 'leftsize-security-issue'
        value: 'unencrypted-disk'
      
      - type: tag
        tag: 'leftsize-severity'
        value: 'high'
      
      - type: tag
        tag: 'leftsize-compliance'
        value: 'CIS-Azure-Foundations'
      
      - type: tag
        tag: 'leftsize-detected-date'
        value: '{now:%Y-%m-%d}'
      
      - type: mark-for-op
        op: notify
        days: 1
        tag: leftsize-unencrypted-disk-notify

  # ========================================
  # üè∑Ô∏è OWNERSHIP TAG COMPLIANCE
  # ========================================
  
  - name: leftsize-missing-ownership-tags-vm
    description: |
      Ensure all virtual machines have clear ownership metadata for cost tracking and accountability.
      
      Resources without ownership tags create hidden spend, block cleanup, and prevent accurate
      cost allocation. This rule identifies VMs missing the required 'owner' tag.
      
      Detection criteria:
      - Missing 'owner' tag
      - Empty or null 'owner' tag value
      
      Governance impact: HIGH - Cost attribution, accountability, lifecycle management
      Compliance: FinOps best practices, cost allocation policies
    
    resource: azure.vm
    metadata:
      tier: pro
    
    filters:
      # Check for missing or empty owner tag
      - or:
        # Owner tag does not exist
        - type: value
          key: 'tags.owner'
          value: null
        
        # Owner tag exists but is empty
        - type: value
          key: 'tags.owner'
          value: ''
    
    actions:
      - type: tag
        tag: 'leftsize-governance-issue'
        value: 'missing-ownership-tags'
      
      - type: tag
        tag: 'leftsize-severity'
        value: 'medium'
      
      - type: tag
        tag: 'leftsize-compliance'
        value: 'finops-tagging-policy'
      
      - type: tag
        tag: 'leftsize-detected-date'
        value: '{now:%Y-%m-%d}'
      
      - type: mark-for-op
        op: notify
        days: 1
        tag: leftsize-ownership-tags-notify

  # Apply same ownership tag check to Storage Accounts
  - name: leftsize-missing-ownership-tags-storage
    description: |
      Ensure all Azure Storage Accounts have clear ownership metadata.
    
    resource: azure.storage
    metadata:
      tier: pro
    
    filters:
      - or:
        - type: value
          key: 'tags.owner'
          value: null
        - type: value
          key: 'tags.owner'
          value: ''
    
    actions:
      - type: tag
        tag: 'leftsize-governance-issue'
        value: 'missing-ownership-tags'
      
      - type: tag
        tag: 'leftsize-severity'
        value: 'medium'
      
      - type: mark-for-op
        op: notify
        days: 1
        tag: leftsize-ownership-tags-notify

  # Apply same ownership tag check to SQL Databases
  - name: leftsize-missing-ownership-tags-sql
    description: |
      Ensure all Azure SQL Databases have clear ownership metadata.
    
    resource: azure.sqlserver
    metadata:
      tier: pro
    
    filters:
      - or:
        - type: value
          key: 'tags.owner'
          value: null
        - type: value
          key: 'tags.owner'
          value: ''
    
    actions:
      - type: tag
        tag: 'leftsize-governance-issue'
        value: 'missing-ownership-tags'
      
      - type: tag
        tag: 'leftsize-severity'
        value: 'medium'
      
      - type: mark-for-op
        op: notify
        days: 1
        tag: leftsize-ownership-tags-notify

  # Apply same ownership tag check to Managed Disks
  - name: leftsize-missing-ownership-tags-disk
    description: |
      Ensure all Azure Managed Disks have clear ownership metadata.
    
    resource: azure.disk
    metadata:
      tier: pro
    
    filters:
      - or:
        - type: value
          key: 'tags.owner'
          value: null
        - type: value
          key: 'tags.owner'
          value: ''
    
    actions:
      - type: tag
        tag: 'leftsize-governance-issue'
        value: 'missing-ownership-tags'
      
      - type: tag
        tag: 'leftsize-severity'
        value: 'medium'
      
      - type: mark-for-op
        op: notify
        days: 1
        tag: leftsize-ownership-tags-notify

  # Apply same ownership tag check to AKS Clusters
  - name: leftsize-missing-ownership-tags-aks
    description: |
      Ensure all AKS clusters have clear ownership metadata.
    
    resource: azure.aks
    metadata:
      tier: pro
    
    filters:
      - or:
        - type: value
          key: 'tags.owner'
          value: null
        - type: value
          key: 'tags.owner'
          value: ''
    
    actions:
      - type: tag
        tag: 'leftsize-governance-issue'
        value: 'missing-ownership-tags'
      
      - type: tag
        tag: 'leftsize-severity'
        value: 'medium'
      
      - type: mark-for-op
        op: notify
        days: 1
        tag: leftsize-ownership-tags-notify

  # Apply same ownership tag check to Resource Groups
  - name: leftsize-missing-ownership-tags-resourcegroup
    description: |
      Ensure all Resource Groups have clear ownership metadata.
      Tags on resource groups can be inherited by child resources through Azure Policy.
    
    resource: azure.resourcegroup
    metadata:
      tier: pro
    
    filters:
      - or:
        - type: value
          key: 'tags.owner'
          value: null
        - type: value
          key: 'tags.owner'
          value: ''
    
    actions:
      - type: tag
        tag: 'leftsize-governance-issue'
        value: 'missing-ownership-tags'
      
      - type: tag
        tag: 'leftsize-severity'
        value: 'medium'
      
      - type: mark-for-op
        op: notify
        days: 1
        tag: leftsize-ownership-tags-notify

  # ========================================
  # üìù TEMPLATE FOR FUTURE GOVERNANCE RULES
  # ========================================
  # 
  # Copy this template when adding new Azure governance/security rules:
  #
  # - name: leftsize-[security-issue]
  #   description: |
  #     [Detailed description of security issue]
  #     
  #     Security impact: [CRITICAL|HIGH|MEDIUM|LOW]
  #     Compliance: [Standards]
  #   
  #   resource: azure.[resource-type]
  #   
  #   filters:
  #     # Add filters to detect the security issue
  #     - type: value
  #       key: '[property-path]'
  #       value: '[value-to-match]'
  #   
  #   actions:
  #     - type: tag
  #       key: 'leftsize-security-issue'
  #       value: '[issue-name]'
  #     
  #     - type: tag
  #       key: 'leftsize-severity'
  #       value: '[critical|high|medium|low]'
  #     
  #     - type: mark-for-op
  #       op: notify
  #       days: 1
  #       tag: leftsize-[issue]-notify
  #
  # ========================================
